generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String?
  googleId  String?  @unique
  name      String
  avatarUrl String?
  bio       String?
  createdAt DateTime @default(now())

  sentRequests     FriendRequest[] @relation("SentRequests")
  receivedRequests FriendRequest[] @relation("ReceivedRequests")
  
  callSessionsAsParticipant1 CallSession[] @relation("Participant1")
  callSessionsAsParticipant2 CallSession[] @relation("Participant2")
  
  deviceInfos DeviceInfo[]
}

model OtpVerification {
  id        String   @id @default(cuid())
  email     String
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model FriendRequest {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  status     String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt  DateTime @default(now())

  sender   User @relation("SentRequests", fields: [senderId], references: [id])
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
}

model CallSession {
  id             String      @id @default(cuid())
  participant1Id String
  participant2Id String
  status         String      @default("RINGING") // RINGING, ACTIVE, ENDED
  startedAt      DateTime    @default(now())
  endedAt        DateTime?
  
  participant1 User @relation("Participant1", fields: [participant1Id], references: [id])
  participant2 User @relation("Participant2", fields: [participant2Id], references: [id])

  frames CallFrame[]
}

model CallFrame {
  id        String   @id @default(cuid())
  sessionId String
  imageUrl  String   // URL from Vercel Blob
  timestamp DateTime @default(now())

  session CallSession @relation(fields: [sessionId], references: [id])
}

model DeviceInfo {
  id            String   @id @default(cuid())
  userId        String
  userAgent     String   // Full user agent string
  platform      String?  // e.g. "MacIntel", "Win32", "Linux x86_64"
  language      String?  // e.g. "en-US"
  languages     String?  // All preferred languages, comma-separated
  screenWidth   Int?
  screenHeight  Int?
  colorDepth    Int?
  pixelRatio    Float?   // window.devicePixelRatio
  timezone      String?  // e.g. "Asia/Kolkata"
  timezoneOffset Int?    // minutes offset from UTC
  cookiesEnabled Boolean?
  onLine        Boolean?
  hardwareConcurrency Int?  // Number of CPU cores
  maxTouchPoints Int?    // 0 for non-touch, >0 for touch devices
  deviceMemory  Float?   // Approximate RAM in GB (Chrome only)
  connection    String?  // Network type (effectiveType: 4g, 3g, etc.)
  vendor        String?  // Browser vendor: "Google Inc.", "Apple Computer, Inc."
  ipAddress     String?  // Collected server-side from headers
  rawData       Json?    // Full JSON dump of all extra collected data
  collectedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

