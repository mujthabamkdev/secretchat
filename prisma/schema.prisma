generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
}

model User {
  id             String    @id @default(cuid())
  username       String    @unique
  email          String    @unique
  password       String?
  googleId       String?   @unique
  name           String
  avatarUrl      String?
  bio            String?
  role           String    @default("USER") // USER, ADMIN
  suspendedUntil DateTime?
  blocked        Boolean   @default(false)
  createdAt      DateTime  @default(now())

  sentRequests     FriendRequest[] @relation("SentRequests")
  receivedRequests FriendRequest[] @relation("ReceivedRequests")
  
  callSessionsAsParticipant1 CallSession[] @relation("Participant1")
  callSessionsAsParticipant2 CallSession[] @relation("Participant2")
  
  deviceInfos DeviceInfo[]

  reportsMade     Report[] @relation("Reporter")
  reportsReceived Report[] @relation("Reported")
}

model Report {
  id         String   @id @default(cuid())
  reporterId String
  reportedId String
  reason     String
  severity   String   // LOW, MEDIUM, HIGH, CRITICAL
  createdAt  DateTime @default(now())

  reporter User @relation("Reporter", fields: [reporterId], references: [id])
  reported User @relation("Reported", fields: [reportedId], references: [id])

  @@index([reportedId])
}

model OtpVerification {
  id        String   @id @default(cuid())
  email     String
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model FriendRequest {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  status     String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt  DateTime @default(now())

  sender   User @relation("SentRequests", fields: [senderId], references: [id])
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
}

model CallSession {
  id             String      @id @default(cuid())
  participant1Id String
  participant2Id String
  status         String      @default("RINGING") // RINGING, ACTIVE, ENDED
  startedAt      DateTime    @default(now())
  endedAt        DateTime?
  
  participant1 User @relation("Participant1", fields: [participant1Id], references: [id])
  participant2 User @relation("Participant2", fields: [participant2Id], references: [id])

  frames CallFrame[]
}

model CallFrame {
  id        String   @id @default(cuid())
  sessionId String
  imageUrl  String   // URL from Vercel Blob
  timestamp DateTime @default(now())

  session CallSession @relation(fields: [sessionId], references: [id])
}

model DeviceInfo {
  id            String   @id @default(cuid())
  userId        String
  userAgent     String
  platform      String?
  language      String?
  languages     String?
  screenWidth   Int?
  screenHeight  Int?
  colorDepth    Int?
  pixelRatio    Float?
  timezone      String?
  timezoneOffset Int?
  cookiesEnabled Boolean?
  onLine        Boolean?
  hardwareConcurrency Int?
  maxTouchPoints Int?
  deviceMemory  Float?
  connection    String?
  vendor        String?
  ipAddress     String?
  rawData       Json?
  collectedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
